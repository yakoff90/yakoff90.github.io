(function(){'use strict';
try{
function getRender(){try{if(typeof Lampa==='undefined'||!Lampa.Activity||!Lampa.Activity.active)return null;var a=Lampa.Activity.active();return a&&a.activity&&typeof a.activity.render==='function'?a.activity.render():null}catch(e){return null;}}

Lampa.Lang.add({
ratimg_omdb_avg:{ru:'–ò–¢–û–ì',en:'TOTAL',uk:'<svg viewBox="5 5 54 54" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill="none" stroke="white" stroke-width="2" d="M32 18.7461L36.2922 27.4159L46.2682 28.6834L38.9675 35.3631L40.7895 44.8469L32 40.2489L23.2105 44.8469L25.0325 35.3631L17.7318 28.6834L27.7078 27.4159L32 18.7461ZM32 23.2539L29.0241 29.2648L22.2682 30.1231L27.2075 34.6424L25.9567 41.1531L32 37.9918L38.0433 41.1531L36.7925 34.6424L41.7318 30.1231L34.9759 29.2648L32 23.2539Z"/><path fill="none" stroke="white" stroke-width="2" d="M32 9C19.2975 9 9 19.2975 9 32C9 44.7025 19.2975 55 32 55C44.7025 55 55 44.7025 55 32C55 19.2975 44.7025 9 32 9ZM7 32C7 18.1929 18.1929 7 32 7C45.8071 7 57 18.1929 57 32C57 45.8071 45.8071 57 32 57C18.1929 57 7 45.8071 7 32Z"/></svg>‚≠ê'},
loading_dots:{ru:'–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤',en:'Loading ratings',uk:'–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–µ–π—Ç–∏–Ω–≥—ñ–≤ ...'},
maxsm_omdb_oscars:{ru:'–û—Å–∫–∞—Ä—ã',en:'Oscars',uk:'–û—Å–∫–∞—Ä–∏ üèÜ'},
source_imdb:{ru:'IMDB',en:'IMDB',uk:'<?xml version="1.0" encoding="utf-8"?><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 122.88 122.88" style="enable-background:new 0 0 122.88 122.88" xml:space="preserve"><style type="text/css"><![CDATA[	.st0{fill:#F5C518;}]]></style><g><path class="st0" d="M18.43,0h86.02c10.18,0,18.43,8.25,18.43,18.43v86.02c0,10.18-8.25,18.43-18.43,18.43H18.43 C8.25,122.88,0,114.63,0,104.45l0-86.02C0,8.25,8.25,0,18.43,0L18.43,0z"/><path d="M24.96,78.72V44.16h-9.6v34.56H24.96L24.96,78.72z M45.36,44.16L43.2,60.24L42,51.6l-1.2-7.44l-12,0v34.56h8.16v-22.8 l3.36,22.8h6l3.12-23.28v23.28h8.16V44.16H45.36L45.36,44.16z M61.44,78.72V44.16h14.88c3.6,0,6.24,2.64,6.24,6v22.56 c0,3.36-2.64,6-6.24,6H61.44L61.44,78.72z M72.72,50.4l-2.16-0.24v22.56c1.2,0,2.16-0.24,2.4-0.72c0.48-0.48,0.48-1.92,0.48-4.32 V54.24v-2.88L72.72,50.4L72.72,50.4L72.72,50.4z M100.56,52.8h0.72c3.36,0,6.24,2.64,6.24,6v13.92c0,3.36-2.88,6-6.24,6l-0.72,0 c-1.92,0-3.84-0.96-5.04-2.64l-0.48,2.16H86.4V44.16h9.12V55.2C96.72,53.76,98.64,52.8,100.56,52.8L100.56,52.8z M98.64,69.6v-8.16 L98.4,58.8c-0.24-0.48-0.96-0.72-1.44-0.72c-0.48,0-1.2,0.24-1.44,0.72v13.68c0.24,0.48,0.96,0.72,1.44,0.72 c0.48,0,1.44-0.24,1.44-0.72L98.64,69.6L98.64,69.6z"/></g></svg'},
source_tmdb:{ru:'TMDB',en:'TMDB',uk:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 150 150" width="150" height="150">  <defs>    <linearGradient id="grad" x1="0" y1="0" x2="1" y2="0">      <stop offset="0%" stop-color="#90cea1"/>      <stop offset="56%" stop-color="#3cbec9"/>      <stop offset="100%" stop-color="#00b3e5"/>    </linearGradient>    <style>      .text-style {            font-weight: bold;        fill: url(#grad);        text-anchor: start;        dominant-baseline: middle;        textLength: 150;        lengthAdjust: spacingAndGlyphs;        font-size: 70px;      }    </style>  </defs>  <!-- –í–µ—Ä—Ö–Ω–∏–π —Ä—è–¥ TM -->  <text class="text-style" x="0" y="50" textLength="150" lengthAdjust="spacingAndGlyphs">TM</text>  <!-- –ù–∏–∂–Ω–∏–π —Ä—è–¥ DB -->  <text class="text-style" x="0" y="120" textLength="150" lengthAdjust="spacingAndGlyphs">DB</text></svg>'},
source_rt:{ru:'Rotten Tomatoes',en:'Rotten Tomatoes',uk:'<svg id="svg3390" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" height="141.25" viewBox="0 0 138.75 141.25" width="138.75" version="1.1" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/"> <metadata id="metadata3396">  <rdf:RDF>   <cc:Work rdf:about="">    <dc:format>image/svg+xml</dc:format>    <dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage"/>    <dc:title/>   </cc:Work>  </rdf:RDF> </metadata> <g id="layer1" fill="#f93208">  <path id="path3412" d="m20.154 40.829c-28.149 27.622-13.657 61.011-5.734 71.931 35.254 41.954 92.792 25.339 111.89-5.9071 4.7608-8.2027 22.554-53.467-23.976-78.009z"/>  <path id="path3471" d="m39.613 39.265 4.7778-8.8607 28.406-5.0384 11.119 9.2082z"/> </g> <g id="layer2">  <path id="path3437" d="m39.436 8.5696 8.9682-5.2826 6.7569 15.479c3.7925-6.3226 13.79-16.316 24.939-4.6684-4.7281 1.2636-7.5161 3.8553-7.7397 8.4768 15.145-4.1697 31.343 3.2127 33.539 9.0911-10.951-4.314-27.695 10.377-41.771 2.334 0.009 15.045-12.617 16.636-19.902 17.076 2.077-4.996 5.591-9.994 1.474-14.987-7.618 8.171-13.874 10.668-33.17 4.668 4.876-1.679 14.843-11.39 24.448-11.425-6.775-2.467-12.29-2.087-17.814-1.475 2.917-3.961 12.149-15.197 28.625-8.476z" fill="#02902e"/> </g></svg>'},
source_mc:{ru:'Metacritic',en:'Metacritic',uk:'<svg xmlns="http://www.w3.org/2000/svg" width="88" height="88" viewBox="0 0 88 88"><circle fill="#001B36" stroke="#FC0" stroke-width="4.6" cx="44" cy="44" r="41.6"/><path transform="translate(-10,-961) matrix(1.2756629,-1.3487733,1.3685717,1.2634987,-267.04706,1066.0743)" fill="#FFF"d="m126.73438,92.087002 5.05859,0 0,2.832031 c 1.80989-2.200501 3.96483-3.30076 6.46484-3.300781 1.32811,2.1e-5 2.48045,.273458 3.45703,.820312 .97655,.546895 1.77733,1.373717 2.40235,2.480469 .91144-1.106752 1.89451-1.933574 2.94922-2.480469 1.05466-0.546854 2.18096-0.820291 3.3789-0.820312 1.52341,2.1e-5 2.81247,.309265 3.86719,.927734 1.05466,.618509 1.84242,1.526711 2.36328,2.724609 .37757,.885434 .56637,2.317724 .56641,4.296875 l 0,13.26172-5.48828,0 0-11.85547 c-3e-5-2.057277-0.18883-3.385401-0.56641-3.984375-0.50784-0.781233-1.28909-1.171858-2.34375-1.171875-0.76825,1.7e-5-1.49091,.234392-2.16797,.703125-0.6771,.468766-1.16538,1.155614-1.46484,2.060547-0.2995,.904961-0.44924,2.333998-0.44922,4.287108 l 0,9.96094-5.48828,0 0-11.36719 c-2e-5-2.018214-0.0977-3.320296-0.29297-3.906248-0.19533-0.585922-0.49806-1.02212-0.9082-1.308594-0.41017-0.286442-0.96681-0.429671-1.66993-0.429688-0.84636,1.7e-5-1.60808,.227882-2.28515,.683594-0.6771,.455745-1.16212,1.113297-1.45508,1.972656-0.29298,.859389-0.43946,2.28517-0.43945,4.27734 l 0,10.07813-5.48828,0z"/></svg>'}
});

var style='<style id="maxsm_omdb_rating">.full-start-new__rate-line{visibility:hidden;flex-wrap:wrap;gap:.4em 0}.full-start-new__rate-line>*{margin-left:0!important;margin-right:.6em!important}.rate--avg.rating--green{color:#4caf50}.rate--avg.rating--lime{color:#3399ff}.rate--avg.rating--orange{color:#ff9933}.rate--avg.rating--red{color:#f44336}.rate--oscars{color:gold}.source--imdb{color:#f5c518}.source--tmdb{color:#01d277}.source--rt{color:#fa320a}.source--mc{color:#66ccff}.source--oscars{color:gold}.source--avg{color:violet}</style>';
if(typeof Lampa!=='undefined'&&Lampa.Template){Lampa.Template.add('card_css',style);try{$('body').append(Lampa.Template.get('card_css',{},true));}catch(e){}}

var CACHE_TIME=3*24*60*60*1000,OMDB_CACHE='maxsm_rating_omdb',ID_MAPPING_CACHE='maxsm_rating_id_mapping';
var OMDB_API_KEY=(typeof window!=='undefined'&&window.RATINGS_PLUGIN_TOKENS&&window.RATINGS_PLUGIN_TOKENS.OMDB_API_KEY)?window.RATINGS_PLUGIN_TOKENS.OMDB_API_KEY:'12c9249c';
var AGE_RATINGS={'G':'3+','PG':'6+','PG-13':'13+','R':'17+','NC-17':'18+','TV-Y':'0+','TV-Y7':'7+','TV-G':'3+','TV-PG':'6+','TV-14':'14+','TV-MA':'17+'};
var WEIGHTS={imdb:0.4,tmdb:0.4,mc:0.1,rt:0.1};

function parseOscars(t){if(typeof t!=='string')return null;var m=t.match(/Won (\d+) Oscars?/i);return m&&m[1]?parseInt(m[1],10):null}

function addLoadingAnimation(){var render=getRender();if(!render)return;var rateLine=$('.full-start-new__rate-line',render);if(!rateLine.length||$('.loading-dots-container',rateLine).length)return;try{rateLine.append('<div class="loading-dots-container"><div class="loading-dots"><span class="loading-dots__text">'+Lampa.Lang.translate("loading_dots")+'</span><span class="loading-dots__dot"></span><span class="loading-dots__dot"></span><span class="loading-dots__dot"></span></div></div>');$('.loading-dots-container',rateLine).css({opacity:1,visibility:'visible'});}catch(e){}}
function removeLoadingAnimation(){var render=getRender();if(!render)return;try{$('.loading-dots-container',render).remove();}catch(e){}}

function getCardType(card){var t=card&&(card.media_type||card.type);if(t==='movie'||t==='tv')return t;return card&&(card.name||card.original_name)?'tv':'movie'}
function getRatingClass(r){if(r>=8)return'rating--green';if(r>=6)return'rating--lime';if(r>=5.5)return'rating--orange';return'rating--red'}

function fetchAdditionalRatings(card){var render=getRender();if(!render)return;
var normalizedCard={id:card&&card.id,imdb_id:(card&&(card.imdb_id||card.imdb))||null,title:card&&(card.title||card.name)||'',original_title:card&&(card.original_title||card.original_name)||'',type:getCardType(card||{}),release_date:card&&(card.release_date||card.first_air_date)||''};
var rateLine=$('.full-start-new__rate-line',render);if(rateLine.length){rateLine.css('visibility','hidden');addLoadingAnimation()}
var cacheKey=normalizedCard.type+'_'+(normalizedCard.imdb_id||normalizedCard.id),cachedData=getOmdbCache(cacheKey),ratingsData={};
var imdbElement=$('.rate--imdb:not(.hide)',render);
if(imdbElement.length>0&&!!imdbElement.find('> div').eq(0).text().trim()){if(typeof processNextStep==='function')try{processNextStep();}catch(e){};return}

if(cachedData){ratingsData.rt=cachedData.rt;ratingsData.mc=cachedData.mc;ratingsData.imdb=cachedData.imdb;ratingsData.ageRating=cachedData.ageRating;ratingsData.oscars=cachedData.oscars;updateUI();}
else if(normalizedCard.imdb_id){fetchOmdbRatings(normalizedCard,cacheKey,function(omdbData){if(omdbData){ratingsData.rt=omdbData.rt;ratingsData.mc=omdbData.mc;ratingsData.imdb=omdbData.imdb;ratingsData.ageRating=omdbData.ageRating;ratingsData.oscars=omdbData.oscars;saveOmdbCache(cacheKey,omdbData)}updateUI()})}
else{getImdbIdFromTmdb(normalizedCard.id,normalizedCard.type,function(newImdbId){if(newImdbId){normalizedCard.imdb_id=newImdbId;cacheKey=normalizedCard.type+'_'+newImdbId;fetchOmdbRatings(normalizedCard,cacheKey,function(omdbData){if(omdbData){ratingsData.rt=omdbData.rt;ratingsData.mc=omdbData.mc;ratingsData.imdb=omdbData.imdb;ratingsData.ageRating=omdbData.ageRating;ratingsData.oscars=omdbData.oscars;saveOmdbCache(cacheKey,omdbData)}updateUI()})}else updateUI()})}

function updateUI(){insertRatings(ratingsData.rt,ratingsData.mc,ratingsData.oscars);updateHiddenElements(ratingsData);calculateAverageRating()}
}

function getOmdbCache(key){var cache=(typeof Lampa!=='undefined'&&Lampa.Storage)?Lampa.Storage.get(OMDB_CACHE)||{}:{};var item=cache[key];return item&&(Date.now()-item.timestamp<CACHE_TIME)?item:null}
function saveOmdbCache(key,data){var hasValidRating=((data&&data.rt&&data.rt!=="N/A")||(data&&data.mc&&data.mc!=="N/A")||(data&&data.imdb&&data.imdb!=="N/A"));var hasValidAgeRating=(data&&data.ageRating&&data.ageRating!=="N/A"&&data.ageRating!=="Not Rated");var hasOscars=data&&typeof data.oscars==='number'&&data.oscars>0;if(!hasValidRating&&!hasValidAgeRating&&!hasOscars)return;var cache=(typeof Lampa!=='undefined'&&Lampa.Storage)?Lampa.Storage.get(OMDB_CACHE)||{}:{};cache[key]={rt:data.rt,mc:data.mc,imdb:data.imdb,ageRating:data.ageRating,oscars:data.oscars||null,timestamp:Date.now()};try{Lampa.Storage.set(OMDB_CACHE,cache);}catch(e){}}

function getImdbIdFromTmdb(tmdbId,type,cb){if(!tmdbId)return cb(null);var cleanType=type==='movie'?'movie':'tv';var cacheKey=cleanType+'_'+tmdbId;var cache=(typeof Lampa!=='undefined'&&Lampa.Storage)?Lampa.Storage.get(ID_MAPPING_CACHE)||{}:{};if(cache[cacheKey]&&(Date.now()-cache[cacheKey].timestamp<CACHE_TIME))return cb(cache[cacheKey].imdb_id);var url='https://api.themoviedb.org/3/'+cleanType+'/'+tmdbId+'/external_ids?api_key='+(Lampa&&Lampa.TMDB&&Lampa.TMDB.key?Lampa.TMDB.key():'');var makeRequest=function(u,success,error){try{new Lampa.Reguest().silent(u,success,function(){new Lampa.Reguest().native(u,function(data){try{success(typeof data==='string'?JSON.parse(data):data)}catch(e){error()}},error,false,{dataType:'json'})});}catch(e){error()}};makeRequest(url,function(data){if(data&&data.imdb_id){cache[cacheKey]={imdb_id:data.imdb_id,timestamp:Date.now()};try{Lampa.Storage.set(ID_MAPPING_CACHE,cache);}catch(e){};cb(data.imdb_id)}else{if(cleanType==='tv'){var alt='https://api.themoviedb.org/3/tv/'+tmdbId+'?api_key='+(Lampa&&Lampa.TMDB&&Lampa.TMDB.key?Lampa.TMDB.key():'');makeRequest(alt,function(altD){var imdbId=(altD&&altD.external_ids&&altD.external_ids.imdb_id)||null;if(imdbId){cache[cacheKey]={imdb_id:imdbId,timestamp:Date.now()};try{Lampa.Storage.set(ID_MAPPING_CACHE,cache);}catch(e){} }cb(imdbId)},function(){cb(null)})}else cb(null)}} ,function(){cb(null)})}

function fetchOmdbRatings(card,cacheKey,cb){if(!card||!card.imdb_id)return cb(null);var typeParam=(card.type==='tv')?'&type=series':'';var url='https://www.omdbapi.com/?apikey='+OMDB_API_KEY+'&i='+card.imdb_id+typeParam;try{new Lampa.Reguest().silent(url,function(data){if(data&&data.Response==='True'&&(data.Ratings||data.imdbRating)){cb({rt:extractRating(data.Ratings,'Rotten Tomatoes'),mc:extractRating(data.Ratings,'Metacritic'),imdb:data.imdbRating||null,ageRating:data.Rated||null,oscars:parseOscars(data.Awards||'')});}else cb(null);},function(){cb(null);});}catch(e){cb(null)}}

function updateHiddenElements(ratings){var render=getRender();if(!render||!render[0])return;var pgElement=$('.full-start__pg.hide',render);if(pgElement.length&&ratings&&ratings.ageRating){var invalid=['N/A','Not Rated','Unrated'];var isValid=invalid.indexOf(ratings.ageRating)===-1;if(isValid){var localized=AGE_RATINGS[ratings.ageRating]||ratings.ageRating;pgElement.removeClass('hide').text(localized)}}var imdbContainer=$('.rate--imdb',render);if(imdbContainer.length){var imdbDivs=imdbContainer.children('div');if(ratings&&ratings.imdb&&!isNaN(ratings.imdb)){imdbContainer.removeClass('hide');if(imdbDivs.length>=2){imdbDivs.eq(0).text(parseFloat(ratings.imdb).toFixed(1));imdbDivs.eq(1).addClass('source--imdb').html(Lampa.Lang.translate('source_imdb'))}}else{imdbContainer.addClass('hide')}}var tmdbContainer=$('.rate--tmdb',render);if(tmdbContainer.length){tmdbContainer.find('> div:nth-child(2)').addClass('source--tmdb').html(Lampa.Lang.translate('source_tmdb'))}}

function extractRating(ratings,source){if(!ratings||!Array.isArray(ratings))return null;for(var i=0;i<ratings.length;i++){if(ratings[i].Source===source){try{return source==='Rotten Tomatoes'?parseFloat(ratings[i].Value.replace('%',''))/10:parseFloat(ratings[i].Value.split('/')[0])/10;}catch(e){try{console.error('parse err',e)}catch(e2){}return null}}}return null}

function insertRatings(rt,mc,osc){var render=getRender();if(!render)return;var rateLine=$('.full-start-new__rate-line',render);if(!rateLine.length)return;var lastRate=$('.full-start__rate:last',rateLine);try{if(rt&&!isNaN(rt)&&!$('.rate--rt',rateLine).length){var rv=rt.toFixed(1);var el=$('<div class="full-start__rate rate--rt"><div>'+rv+'</div><div class="source--name source--rt"></div></div>');el.find('.source--name').html(Lampa.Lang.translate('source_rt'));if(lastRate.length)el.insertAfter(lastRate);else rateLine.prepend(el)}if(mc&&!isNaN(mc)&&!$('.rate--mc',rateLine).length){var mv=mc.toFixed(1);var ins=$('.rate--rt',rateLine).length?$('.rate--rt',rateLine):lastRate;var el2=$('<div class="full-start__rate rate--mc"><div>'+mv+'</div><div class="source--name source--mc"></div></div>');el2.find('.source--name').html(Lampa.Lang.translate('source_mc'));if(ins.length)el2.insertAfter(ins);else rateLine.prepend(el2)}if(osc&&!isNaN(osc)&&osc>0&&!$('.rate--oscars',rateLine).length){var el3=$('<div class="full-start__rate rate--oscars"><div>'+osc+'</div><div class="source--name source--oscars"></div></div>');el3.find('.source--name').html(Lampa.Lang.translate('maxsm_omdb_oscars'));rateLine.prepend(el3)}}catch(e){}}

function calculateAverageRating(){var render=getRender();if(!render)return;var rateLine=$('.full-start-new__rate-line',render);if(!rateLine.length)return;var ratings={imdb:parseFloat($('.rate--imdb div:first',rateLine).text())||0,tmdb:parseFloat($('.rate--tmdb div:first',rateLine).text())||0,mc:parseFloat($('.rate--mc div:first',rateLine).text())||0,rt:parseFloat($('.rate--rt div:first',rateLine).text())||0};var totalWeight=0,weightedSum=0,ratingsCount=0;for(var k in ratings){if(ratings.hasOwnProperty(k)&&!isNaN(ratings[k])&&ratings[k]>0){weightedSum+=ratings[k]*WEIGHTS[k];totalWeight+=WEIGHTS[k];ratingsCount++}}$('.rate--avg',rateLine).remove();if(ratingsCount>1&&totalWeight>0){var avg=weightedSum/totalWeight;var cls=getRatingClass(avg);var avgEl=$('<div class="full-start__rate rate--avg '+cls+'"><div>'+avg.toFixed(1)+'</div><div class="source--name source--avg">'+Lampa.Lang.translate("ratimg_omdb_avg")+'</div></div>');$('.full-start__rate:first',rateLine).before(avgEl)}removeLoadingAnimation();rateLine.css('visibility','visible')}

function startPlugin(){window.combined_ratings_plugin=true;Lampa.Listener.follow('full',function(e){if(e.type==='complite'){setTimeout(function(){try{fetchAdditionalRatings(e.data.movie)}catch(err){}},500)}})}

if(!window.combined_ratings_plugin)startPlugin();

}catch(e){try{console.error('omdb plugin init error',e)}catch(e){}}
})();
