(function() {
    'use strict';

    /**
     * =========================
     *  CONFIG
     * =========================
     */
    var LMP_ENH_CONFIG = {
        apiKeys: {
            mdblist: 'm8po461k1zq14sroj2ez5d7um', // ✅ ключ до MDBList
            omdb:    '12c9249c'     // ✅ ключ до OMDb
        },

        // true  -> іконки стають монохромні через filter: grayscale(100%)
        // false -> кольорові логотипи як є
        monochromeIcons: false   /*✅ Вкл./Викл. Ч/Б рейтинги */
    };

    /**
     * =========================
     *  ICON SOURCES
     * =========================
     */
    var ICONS = {
        // середній рейтинг (TOTAL)
        total_star: 'https://raw.githubusercontent.com/ko31k/LMPStyle/main/wwwroot/star.png',

        // інші нагороди (не Оскар / не Еммі)
        awards: 'https://raw.githubusercontent.com/ko31k/LMPStyle/main/wwwroot/awards.png',

        // PopcornMeter / Audience Score
        popcorn: 'https://raw.githubusercontent.com/ko31k/LMPStyle/main/wwwroot/popcorn.png',

        // Rotten Tomatoes поганий (гнилий)
        rotten_bad: 'https://raw.githubusercontent.com/ko31k/LMPStyle/main/wwwroot/RottenBad.png',

        // логотипи сервісів (з Enchanser)
        imdb:        'https://www.streamingdiscovery.com/logo/imdb.png',
        tmdb:        'https://www.streamingdiscovery.com/logo/tmdb.png',
        metacritic:  'https://www.streamingdiscovery.com/logo/metacritic.png',
        rotten_good: 'https://www.streamingdiscovery.com/logo/rotten-tomatoes.png'
    };

    /**
     * =========================
     *  Emmy SVG (з оригіналу omdb)
     * =========================
     * Твій повний emmy_svg.
     */
    var emmy_svg = '<svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" id="svg2" version="1.1" width="321" height="563.40002" viewBox="0 0 321 563.40002"> <metadata id="metadata8"> <rdf:RDF> <cc:Work rdf:about=""> <dc:format>image/svg+xml</dc:format> <dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage" /> <dc:title></dc:title> </cc:Work> </rdf:RDF> </metadata> <defs id="defs6" /> <path style="fill:#ffea55;fill-opacity:1" d="m 74.000736,558.45002 c 1.419168,-2.3925 5.869572,-9.89926 9.889782,-16.68169 L 91.2,529.43665 l 0,-18.11832 0,-18.11831 -1.5,0 c -1.314288,0 -1.5,-0.26 -1.5,-2.1 0,-1.82704 0.19056,-2.1 1.466076,-2.1 1.000278,0 1.810464,-0.58445 2.55,-1.83952 3.29883,-5.59841 17.748674,-11.01359 38.883924,-14.57201 15.07121,-2.53745 37.2238,-4.57025 49.93857,-4.58254 5.8672,-0.005 6.15295,-0.0656 6.464,-1.35593 0.179,-0.7425 1.38764,-6.21 2.68589,-12.15 l 2.36044,-10.8 -46.25496,-91.20001 C 127.98142,314.71219 106.27409,279.9457 92.962182,240.13737 88.114902,225.64192 85.404036,218.40266 84.357492,217.15891 82.493382,214.94354 81,210.15143 81,206.38504 c 0,-5.79136 3.886722,-13.68528 8.810394,-17.89391 l 2.666022,-2.27885 -8.333772,-26.65613 -8.333772,-26.65614 -10.754436,-0.37312 C 53.657564,132.13147 49.166702,131.30278 41.468017,128.17453 22.562277,120.49244 8.0414946,103.83674 2.5403311,83.523501 1.1083157,78.235737 0.9617808,76.678893 0.9474399,66.600014 0.93373098,56.965242 1.1077609,54.853206 2.2658231,50.600046 2.9996204,47.905064 3.6,45.051569 3.6,44.258946 3.6,41.308294 5.4985663,36.582977 7.807899,33.785964 9.1184184,32.198691 11.635303,29.010013 13.400976,26.700013 20.094714,17.94271 28.752256,10.929783 38.626436,6.2664654 48.028435,1.8261454 60.505212,-0.52607559 70.79076,0.20258241 76.76664,0.62593341 86.32782,3.2953864 92.701692,6.3200484 102.87171,11.14614 113.28506,20.061692 118.8,28.664521 c 1.78694,2.787483 3.5116,4.67981 5.1,5.595822 3.51801,2.028802 7.6379,6.4128 9.24688,9.839671 1.75952,3.747478 2.23256,9.138201 1.21206,13.812412 -0.43079,1.973174 -0.71217,4.93847 -0.62528,6.58955 0.12527,2.380278 -0.21942,3.719412 -1.66441,6.466381 -1.00231,1.905438 -2.12118,5.14455 -2.48637,7.198044 -1.56897,8.822442 -6.36005,20.95421 -10.33833,26.178259 -7.18039,9.44201 -17.57346,18.27858 -26.09455,22.20792 -1.7325,0.7989 -3.15,1.70018 -3.15,2.00283 0,1.30926 6.725634,21.75143 7.266342,22.08561 0.328836,0.20323 3.025728,4.52965 5.993098,9.61425 2.96737,5.08461 5.21821,8.50047 5.00185,7.5908 -1.03039,-4.3324 2.61944,-9.94923 8.35301,-12.85465 3.57477,-1.81147 9.37776,-2.48312 12.51324,-1.44832 1.87057,0.61734 2.45623,0.51503 5.3368,-0.93229 3.76508,-1.89173 10.6449,-2.57282 14.75838,-1.46106 2.8436,0.76855 5.8258,3.0433 7.41437,5.6555 1.14042,1.87525 9.0202,7.20659 9.62248,6.5104 0.19776,-0.2286 3.81209,-9.32563 8.03185,-20.21563 4.21976,-10.89001 7.78403,-19.99869 7.92061,-20.24153 0.13657,-0.24284 2.42268,0.65172 5.08023,1.98791 2.65755,1.33619 4.89397,2.34488 4.96982,2.24153 0.0759,-0.10336 7.19655,-12.75012 15.82378,-28.103909 8.62723,-15.353798 16.10334,-28.448798 16.61356,-29.100003 0.87677,-1.119006 0.91035,-1.068726 0.61169,0.915997 -0.17381,1.155 -2.21522,17.085 -4.53647,35.399995 -2.32125,18.315 -4.34836,33.8998 -4.50469,34.63289 -0.27243,1.27758 -0.50632,1.1982 -5.6375,-1.91321 l -5.35327,-3.24608 -0.32876,1.6132 c -0.18082,0.88726 -1.68957,11.04664 -3.35278,22.57639 -1.6632,11.52975 -3.16447,21.10365 -3.33615,21.27532 -0.17167,0.17168 -3.40574,-1.22777 -7.18681,-3.10989 -3.78107,-1.88211 -6.87643,-3.22101 -6.87856,-2.97532 -0.013,1.48955 -6.65991,47.21048 -6.89817,47.44875 -0.3262,0.32619 -2.27277,-0.69903 -14.39795,-7.58319 l -8.4,-4.76916 -7.35462,21.97515 c -4.04504,12.08633 -7.5017,22.43494 -7.68146,22.9969 -0.23954,0.7488 0.35068,1.36741 2.20939,2.31565 5.18677,2.64609 11.9275,10.8995 15.86876,19.42983 3.80532,8.23611 5.71185,17.96715 4.53225,23.13277 l -0.61656,2.7 14.51728,28.65811 c 10.78048,21.28139 14.73986,28.57269 15.38193,28.3263 0.84644,-0.3248 57.65033,20.07553 57.6355,20.699 -0.004,0.17412 -8.91414,10.03482 -19.8,21.91264 L 209.4,423.89211 l 0,21.96294 0,21.96295 8.85,0.40375 c 40.55234,1.85009 72.41453,8.97829 80.33073,17.97156 1.76176,2.00147 2.92223,2.80671 4.04491,2.80671 1.39927,0 1.57436,0.23355 1.57436,2.1 0,1.93333 -0.14286,2.1 -1.8,2.1 l -1.8,0 0,17.63244 0,17.63245 9.06443,15.21756 c 4.98543,8.36965 9.59746,16.09505 10.24893,17.16755 l 1.18451,1.95 -124.83872,0 -124.83872,0 z M 73.597602,127.00241 c 0.164172,-0.16417 -0.951516,-4.24865 -2.479314,-9.07661 -3.48879,-11.02485 -2.959782,-10.6958 -15.497704,-9.63975 -6.652075,0.5603 -6.449345,0.20293 -3.241462,5.71396 2.950134,5.06823 9.088502,10.96353 13.020878,12.50526 2.98059,1.16858 7.266258,1.42848 8.197602,0.49714 z M 53.618794,123.41898 C 51.683457,121.3394 49.155,117.96324 48,115.9164 c -4.492639,-7.96169 -3.856145,-7.31639 -7.216476,-7.31639 -7.015931,0 -17.811365,-3.27057 -22.927374,-6.94606 l -2.971964,-2.135143 1.107907,1.923713 c 1.709693,2.96864 9.668443,11.21041 14.007907,14.50604 5.129935,3.91116 14.729887,8.53593 20.7,9.99304 2.64,0.64434 5.168457,1.19108 5.618794,1.21497 0.450336,0.0239 -0.764664,-1.65802 -2.7,-3.73759 z m 43.898534,-5.12175 c 2.960472,-1.92654 5.897612,-4.08719 6.526972,-4.80146 l 1.1443,-1.29865 -2.9443,0.39864 c -4.94824,0.66994 -5.425882,0.96919 -8.227012,5.15425 -1.490904,2.2275 -2.52441,4.05 -2.29668,4.05 0.227724,0 2.836248,-1.57625 5.79672,-3.50278 z m -8.07456,-2.04722 1.850298,-2.55 -1.696536,-0.37901 c -0.93309,-0.20845 -2.333298,-0.41095 -3.111576,-0.45 -1.213794,-0.0609 -1.362444,0.13858 -1.045212,1.40255 0.561312,2.23644 1.493034,4.52646 1.841646,4.52646 0.171096,0 1.14372,-1.1475 2.16138,-2.55 z m 6.337452,-12.75 c 1.034124,-2.64 2.053632,-5.549916 2.265576,-6.466494 l 0.38535,-1.666494 -3.465576,1.732644 c -1.906062,0.952956 -5.670276,2.605477 -8.364918,3.672264 l -4.899348,1.93962 0.636402,1.89423 c 0.350022,1.04183 0.888258,2.21724 1.196082,2.61202 0.59037,0.75715 3.954072,1.23887 7.966212,1.14085 l 2.4,-0.0586 1.88022,-4.8 z m 12.89798,2.31662 c 4.16453,-1.86893 7.26138,-5.06592 9.37106,-9.674066 1.30961,-2.86056 1.46545,-3.85032 1.16691,-7.411297 -0.48858,-5.827734 -0.87483,-6.331002 -3.45027,-4.495602 -1.13624,0.809748 -4.16882,2.910492 -6.73905,4.668312 -3.19353,2.184103 -4.77647,3.670975 -4.99945,4.696039 -0.30776,1.414752 -3.55796,11.61886 0.3757,12.811226 4.15045,1.488653 3.70334,2.316441 4.8496,-1.125107 0.69484,-2.25412 3.00935,-3.66446 7.64874,-3.19925 2.53361,0.275252 4.58048,1.393298 5.50983,2.520095 1.18647,1.323568 0.34608,2.896571 -0.58604,5.068453 l 0,5.66652 c 0.24676,1.6923 -2.81294,4.06076 -5.41136,6.77444 -2.48946,2.71368 -5.23069,4.10766 -9.04192,4.19532 z" id="path26" /> </svg>';

    /**
     * =========================
     *  Rating Formatting and Colors
     * =========================
     */
    function getRatingClass(rating) {
        if (rating >= 8.0) return 'rating--green';  // Висока оцінка (зелений)
        if (rating >= 6.0) return 'rating--lime';   // Помірна оцінка (лайм)
        if (rating >= 5.5) return 'rating--orange'; // Низька оцінка (оранжевий)
        return 'rating--red';                       // Дуже низька оцінка (червоний)
    }

    function formatRating(rating) {
        if (rating !== null && !isNaN(rating)) {
            return rating.toFixed(1);  // Форматуємо оцінку до 1 десяткового знака
        }
        return 'N/A';  // Якщо оцінка недійсна, повертаємо 'N/A'
    }

    // Застосовуємо форматування та колір до ваших оцінок
    function updateRatingsDisplay() {
        var ratingElements = document.querySelectorAll('.rating-element');  // Оновіть правильний селектор

        ratingElements.forEach(function(element) {
            var rating = parseFloat(element.textContent);
            element.textContent = formatRating(rating);
            element.classList.add(getRatingClass(rating));  // Додаємо правильний клас для кольору
        });
    }

    /**
     * =========================
     *  MDBList → рейтинг
     * =========================
     */
    function fetchMdbListRatings(card, callback) {
        var key = LMP_ENH_CONFIG.apiKeys.mdblist;
        if (!key) {
            callback(null);
            return;
        }

        var typeSegment = (card.type === 'tv') ? 'show' : card.type;
        var url = 'https://api.mdblist.com/tmdb/' + typeSegment + '/' + card.id +
                  '?apikey=' + encodeURIComponent(key);

        $.ajax({
            url: url,
            method: 'GET',
            timeout: 0
        }).done(function(response) {
            if (!response || !response.ratings || !response.ratings.length) {
                callback(null);
                return;
            }

            var res = {
                tmdb_display: null,
                tmdb_for_avg: null,

                imdb_display: null,
                imdb_for_avg: null,

                // Metacritic: ми збираємо обидва, а потім оберемо пріоритет пізніше
                mc_user_display: null,
                mc_user_for_avg: null,

                mc_critic_display: null,
                mc_critic_for_avg: null,

                rt_display: null,
                rt_for_avg: null,
                rt_fresh: null,

                popcorn_display: null,
                popcorn_for_avg: null
            };

            function parseRawScore(rawVal) {
                if (rawVal === null || rawVal === undefined) return null;
                if (typeof rawVal === 'number') return rawVal;

                if (typeof rawVal === 'string') {
                    // "73%" -> 73
                    if (rawVal.indexOf('%') !== -1) {
                        return parseFloat(rawVal.replace('%',''));
                    }
                    // "7.8/10" -> 7.8
                    if (rawVal.indexOf('/') !== -1) {
                        return parseFloat(rawVal.split('/')[0]);
                    }
                    // "5.9" -> 5.9
                    return parseFloat(rawVal);
                }
                return null;
            }
            
            response.ratings.forEach(function(r) {
                var src = (r.source || '').toLowerCase();
                var val = parseRawScore(r.value);
                if (val === null || isNaN(val)) return;

                // TMDB
                if (src.indexOf('tmdb') !== -1) {
                    var tmdb10 = val > 10 ? (val / 10) : val;
                    res.tmdb_display = tmdb10.toFixed(1);
                    res.tmdb_for_avg = tmdb10;
                }

                // IMDb
                if (src.indexOf('imdb') !== -1) {
                    var imdb10 = val > 10 ? (val / 10) : val;
                    res.imdb_display = imdb10.toFixed(1);
                    res.imdb_for_avg = imdb10;
                }

                // Metacritic USER score (0..10 зазвичай)
                if (src.indexOf('metacritic') !== -1 && isUserSource(src)) {
                    var user10 = val > 10 ? (val / 10) : val;
                    res.mc_user_display = user10.toFixed(1);
                    res.mc_user_for_avg = user10;
                }

                // Metacritic CRITIC metascore (0..100 зазвичай)
                if (src.indexOf('metacritic') !== -1 && !isUserSource(src)) {
                    var critic10 = val > 10 ? (val / 10) : val; // 73 -> 7.3
                    res.mc_critic_display = critic10.toFixed(1);
                    res.mc_critic_for_avg = critic10;
                }

                // Rotten Tomatoes
                if (src.indexOf('rotten') !== -1 || src.indexOf('tomato') !== -1) {
                    res.rt_display = String(Math.round(val));   // "85"
                    res.rt_for_avg = val / 10;                  // 85 -> 8.5
                    res.rt_fresh = val >= 60;
                }

                // Popcorn
                if (src.indexOf('popcorn') !== -1 || src.indexOf('audience') !== -1) {
                    res.popcorn_display = String(Math.round(val)); // "91"
                    res.popcorn_for_avg = val / 10;                // 91 -> 9.1
                }
            });

            callback(res);
        }).fail(function() {
            callback(null);
        });
    }

})();
